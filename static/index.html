<!doctype html>
<html lang="id">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <title>SADIGIT AI – Image UI</title>
  <style>
    :root {
      --bg: #f5f6f8;
      --panel: #ffffff;
      --line: #e6e8ee;
      --muted: #8a8f98;
      --text: #1d232f;
      --brand: #2f6df6;
      --brand-2: #5ea2ff;
      --danger: #f44336;
      --radius: 14px;
      --shadow: 0 1px 2px rgba(14, 18, 22, .08), 0 8px 24px rgba(14, 18, 22, .08);
      --shadow-soft: 0 1px 2px rgba(14, 18, 22, .04), 0 4px 12px rgba(14, 18, 22, .06);
      --input-bg: #fff;
      --btn-bg: #eef1f7;
      --btn-text: #2a3342;
      --chip-bg: #fbfcfe;
      --chip-hover-bg: #f4f8ff;
      --nav-hover-bg: #f3f6ff;
      --nav-active-bg: #eaf1ff;
      --nav-active-text: #1d232f;
      --nav-active-outline: #d7e5ff;
    }

    body[data-theme="dark"] {
      --bg: #1a1d24;
      --panel: #232730;
      --line: #343842;
      --muted: #7b829b;
      --text: #e3e6f0;
      --danger: #e57373;
      --shadow: 0 1px 2px rgba(0, 0, 0, .1), 0 8px 24px rgba(0, 0, 0, .1);
      --shadow-soft: 0 1px 2px rgba(0, 0, 0, .05), 0 4px 12px rgba(0, 0, 0, .08);
      --input-bg: #232730;
      --btn-bg: #2c313a;
      --btn-text: #c5cadd;
      --chip-bg: #2c313a;
      --chip-hover-bg: #343842;
      --nav-hover-bg: #2c313a;
      --nav-active-bg: #3c69ad;
      --nav-active-text: #fff;
      --nav-active-outline: transparent;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      transition: background-color 0.3s, color 0.3s;
    }

    /* ===== Root layout: Topbar + Body ===== */
    .root {
      display: grid;
      grid-template-rows: 56px 1fr;
      height: 100vh
    }

    .topbar {
      background: var(--panel);
      border-bottom: 1px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 18px;
    }

    .topbar .left {
      display: flex;
      align-items: center;
      gap: 10px
    }

    .topbar .left svg {
      width: 22px;
      height: 22px;
      color: var(--brand)
    }

    .topbar strong {
      font-size: 15px;
      letter-spacing: .2px
    }

    .topbar .right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .topbar .right button {
      border: none;
      background: var(--btn-bg);
      border-radius: 10px;
      padding: 8px 12px;
      cursor: pointer;
      color: var(--btn-text);
      font-weight: 600;
    }

    .topbar .right .icon-btn {
      width: 42px;
      height: 42px;
      padding: 0;
      display: grid;
      place-items: center;
    }

    /* ===== Body: Sidebar + Main ===== */
    .app {
      display: grid;
      grid-template-columns: 260px 1fr;
      height: 100%
    }

    .sidebar {
      background: var(--panel);
      border-right: 1px solid var(--line);
      padding: 18px 14px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .side-title {
      color: var(--muted);
      font-weight: 600;
      font-size: 13px;
      padding: 4px 10px
    }

    /* MODIFIED */
    .nav {
      display: flex;
      flex-direction: column;
      gap: 6px
    }

    .nav a {
      all: unset;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      color: var(--text);
      text-decoration: none;
    }

    .nav a:hover {
      background: var(--nav-hover-bg)
    }

    .nav a.active {
      background: var(--nav-active-bg);
      color: var(--nav-active-text);
      outline: 1px solid var(--nav-active-outline)
    }

    .nav a svg {
      width: 18px;
      height: 18px;
      color: currentColor;
      opacity: 0.6;
    }

    /* MODIFIED */
    .nav a:hover svg,
    .nav a.active svg {
      opacity: 1;
    }

    /* MODIFIED */

    .main {
      padding: 20px;
      overflow: auto
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(320px, 1fr) 560px;
      /* panel kanan lebih lebar */
      gap: 18px;
      height: auto;
    }

    @media (max-width:1100px) {
      .grid {
        grid-template-columns: 1fr
      }
    }

    /* ===== Cards ===== */
    .card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft)
    }

    /* ===== Preview ===== */
    .preview {
      height: auto;
      display: flex;
      flex-direction: column
    }

    .preview-viewport {
      height: 56vh;
      /* ⟵ tinggi nyaman (sekitar 56% viewport) */
      max-height: 720px;
      /* ⟵ batas atas di layar besar */
      min-height: 280px;
      /* ⟵ tetap usable di layar kecil */
      display: flex;
      align-items: center;
      justify-content: center;
      background: #ededf2;
      border-bottom: 1px solid var(--line);
      border-top-left-radius: var(--radius);
      border-top-right-radius: var(--radius);
      position: relative;
      overflow: hidden;
    }

    body[data-theme="dark"] .preview-viewport {
      background: #1f2229;
    }

    .preview-viewport .ph {
      text-align: center;
      color: #b4b8c2;
      user-select: none;
    }

    .preview-viewport .ph svg {
      width: 76px;
      height: 76px;
      display: block;
      margin: 0 auto 10px;
      opacity: .7
    }

    .preview-footer {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 10px;
      padding: 12px;
      background: var(--panel);
      border-bottom-left-radius: var(--radius);
      border-bottom-right-radius: var(--radius);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 600;
      background: var(--btn-bg);
      color: var(--btn-text);
    }

    .btn svg {
      width: 16px;
      height: 16px
    }

    .btn.primary {
      background: linear-gradient(180deg, var(--brand), var(--brand-2));
      color: #fff;
      box-shadow: var(--shadow)
    }

    .btn.primary:active {
      transform: translateY(1px)
    }

    .btn.danger {
      background: var(--danger);
      color: #fff;
    }

    /* ===== Controls panel ===== */
    .panel {
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 14px
    }

    .group {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft)
    }

    .group .hd {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      border-bottom: 1px solid var(--line)
    }

    .group .hd h3 {
      margin: 0;
      font-size: 14px
    }

    .group .bd {
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 12px
    }

    .input,
    textarea,
    select {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: var(--input-bg);
      color: var(--text);
      padding: 10px 12px;
      outline: none;
    }

    .input:focus,
    textarea:focus,
    select:focus {
      border-color: #c8d8ff;
      box-shadow: 0 0 0 3px rgba(47, 109, 246, .15)
    }

    textarea {
      resize: vertical;
      min-height: 42px
    }

    .inline {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 0.01fr 78px;
      gap: 10px;
      align-items: center
    }

    .row>label {
      color: var(--muted);
      font-size: 13px
    }

    /* MODIFIED */
    .range {
      accent-color: var(--brand)
    }

    .muted {
      color: var(--muted);
      font-size: 12px
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px dashed #cfd6e4;
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      background: var(--chip-bg);
    }

    .chip:hover {
      background: var(--chip-hover-bg)
    }

    body[data-theme="dark"] .chip {
      border-color: #4a505c;
    }

    .chip svg {
      width: 16px;
      height: 16px
    }

    details.box {
      border-top: 1px solid var(--line);
      padding-top: 8px
    }

    details.box>summary {
      list-style: none;
      cursor: pointer;
      padding: 10px 0;
      color: var(--text);
      font-weight: 600;
      /* MODIFIED */
    }

    details.box[open]>summary {
      color: var(--brand)
    }

    /* MODIFIED */
    body[data-theme="dark"] details.box[open]>summary {
      color: var(--brand-2);
    }

    .seed-row {
      display: grid;
      grid-template-columns: 1fr 38px;
      gap: 10px;
      align-items: center
    }

    .icon-btn {
      width: 38px;
      height: 38px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: var(--panel);
      cursor: pointer;
      display: grid;
      place-items: center;
      color: var(--text);
      /* ADDED */
    }

    .icon-btn:hover {
      background: var(--nav-hover-bg)
    }

    .icon-btn.lora-remove:hover {
      background: #f9f2f2;
      border-color: #f1c9c9
    }

    body[data-theme="dark"] .icon-btn.lora-remove:hover {
      background: #4d2e2e;
      border-color: #7a3c3c;
    }

    .reset {
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      font-weight: 600;
    }
  </style>
</head>

<body>
  <div class="root">
    <!-- ===== TOPBAR ===== -->
    <header class="topbar">
      <div class="left">
        <svg width="34" height="21" viewBox="0 0 34 21" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12.4348 0.5L5.47826 12.6739L14.1739 7.45652H22.8696L32 0.5H12.4348Z" fill="#3C69AD" />
          <path d="M11.5652 13.5435L2 20.5H22L28.087 8.32609L20.2609 13.5435H11.5652Z" fill="#3C69AD" />
          <path d="M12.4348 0.5L5.47826 12.6739L14.1739 7.45652H22.8696L32 0.5H12.4348Z" stroke="#3C69AD" />
          <path d="M11.5652 13.5435L2 20.5H22L28.087 8.32609L20.2609 13.5435H11.5652Z" stroke="#3C69AD" />
        </svg>
        <strong>SADIGIT AI</strong>
      </div>
      <div class="right">
        <button id="themeToggleBtn" class="icon-btn" title="Toggle theme">
          <svg id="themeIcon" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
            <!-- Ikon akan diatur oleh JS -->
          </svg>
        </button>
      </div>
    </header>

    <!-- ===== BODY ===== -->
    <div class="app">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="side-title">General</div>
        <nav class="nav">
          <a href="/" class="active">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path
                d="M2.5 13.3334L6.22472 9.6086C6.50769 9.32569 6.89148 9.16669 7.29167 9.16669C7.69185 9.16669 8.07564 9.32569 8.35858 9.6086L11.6667 12.9167M11.6667 12.9167L12.9167 14.1667M11.6667 12.9167L13.3081 11.2753C13.591 10.9924 13.9748 10.8334 14.375 10.8334C14.7752 10.8334 15.159 10.9924 15.4419 11.2753L17.5 13.3334"
                stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
              <path
                d="M12.9167 6.66665C13.1467 6.66665 13.3333 6.4801 13.3333 6.24998C13.3333 6.01986 13.1467 5.83331 12.9167 5.83331M12.9167 6.66665C12.6866 6.66665 12.5 6.4801 12.5 6.24998C12.5 6.01986 12.6866 5.83331 12.9167 5.83331M12.9167 6.66665V5.83331"
                stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
              <path
                d="M3.0818 16.456C2.0835 15.2871 2.0835 13.5247 2.0835 9.99998C2.0835 6.4752 2.0835 4.71281 3.0818 3.54395C3.22356 3.37796 3.37815 3.22338 3.54413 3.08162C4.713 2.08331 6.47539 2.08331 10.0002 2.08331C13.5249 2.08331 15.2873 2.08331 16.4562 3.08162C16.6222 3.22338 16.7767 3.37796 16.9185 3.54395C17.9168 4.71281 17.9168 6.4752 17.9168 9.99998C17.9168 13.5247 17.9168 15.2871 16.9185 16.456C16.7767 16.622 16.6222 16.7766 16.4562 16.9183C15.2873 17.9166 13.5249 17.9166 10.0002 17.9166C6.47539 17.9166 4.713 17.9166 3.54413 16.9183C3.37815 16.7766 3.22356 16.622 3.0818 16.456Z"
                stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            AI Image
          </a>
          <a href="audio">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M7.5 2.5V17.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                stroke-linejoin="round" />
              <path d="M5 5.83331V14.1666" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                stroke-linejoin="round" />
              <path d="M10 5V15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                stroke-linejoin="round" />
              <path d="M12.5 7.5V12.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                stroke-linejoin="round" />
              <path d="M15 5.83331V14.1666" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                stroke-linejoin="round" />
              <path d="M17.5 9.16669V10.8334" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                stroke-linejoin="round" />
              <path d="M2.5 9.16669V10.8334" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                stroke-linejoin="round" />
            </svg>
            AI Audio
          </a>
          <a href="video">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path
                d="M1.6665 9.16665C1.6665 6.41679 1.6665 5.04185 2.52078 4.18759C3.37505 3.33331 4.74998 3.33331 7.49984 3.33331H8.33317C11.083 3.33331 12.4579 3.33331 13.3123 4.18759C14.1665 5.04185 14.1665 6.41679 14.1665 9.16665V10.8333C14.1665 13.5831 14.1665 14.9581 13.3123 15.8124C12.4579 16.6666 11.083 16.6666 8.33317 16.6666H7.49984C4.74998 16.6666 3.37505 16.6666 2.52078 15.8124C1.6665 14.9581 1.6665 13.5831 1.6665 10.8333V9.16665Z"
                stroke="currentColor" stroke-width="1.5" />
              <path
                d="M14.1665 7.42156L14.2714 7.33499C16.0346 5.88021 16.9162 5.15282 17.6247 5.50404C18.3332 5.85526 18.3332 7.01965 18.3332 9.34844V10.6516C18.3332 12.9804 18.3332 14.1448 17.6247 14.496C16.9162 14.8472 16.0346 14.1199 14.2714 12.665L14.1665 12.5784"
                stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
              <path
                d="M9.5835 9.16669C10.2739 9.16669 10.8335 8.60704 10.8335 7.91669C10.8335 7.22633 10.2739 6.66669 9.5835 6.66669C8.89314 6.66669 8.3335 7.22633 8.3335 7.91669C8.3335 8.60704 8.89314 9.16669 9.5835 9.16669Z"
                stroke="currentColor" stroke-width="1.5" />
            </svg>
            AI Video
          </a>
          <a href="faceswap">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path
                d="M2.0835 6.82229C2.17021 5.07252 2.42964 3.98158 3.2057 3.20551C3.98176 2.42945 5.0727 2.17003 6.82247 2.08331M17.9168 6.82229C17.8301 5.07252 17.5707 3.98158 16.7947 3.20551C16.0186 2.42945 14.9276 2.17003 13.1778 2.08331M13.1778 17.9166C14.9276 17.8299 16.0186 17.5705 16.7947 16.7945C17.5707 16.0184 17.8301 14.9274 17.9168 13.1776M6.82246 17.9166C5.0727 17.8299 3.98176 17.5705 3.2057 16.7945C2.42964 16.0184 2.17021 14.9274 2.0835 13.1776"
                stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
              <path
                d="M14.5832 14.1667L14.4147 13.4593C14.2754 12.8748 13.8323 12.4104 13.2549 12.2441L11.2498 11.6662L11.2496 10.4432C11.9968 9.93883 12.4996 8.99625 12.4996 7.91667C12.4996 6.30583 11.3803 5 9.99959 5C8.61884 5 7.49955 6.30583 7.49955 7.91667C7.49955 8.99625 8.0023 9.93883 8.74959 10.4432L8.74984 11.6662L6.75721 12.2495C6.19773 12.4133 5.76448 12.8575 5.61473 13.4209L5.4165 14.1667"
                stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            Face Swap
          </a>
          <a href="uno">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path
                d="M2.5 13.3334L6.22472 9.6086C6.50769 9.32569 6.89148 9.16669 7.29167 9.16669C7.69185 9.16669 8.07564 9.32569 8.35858 9.6086L11.6667 12.9167M11.6667 12.9167L12.9167 14.1667M11.6667 12.9167L13.3081 11.2753C13.591 10.9924 13.9748 10.8334 14.375 10.8334C14.7752 10.8334 15.159 10.9924 15.4419 11.2753L17.5 13.3334"
                stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
              <path
                d="M12.9167 6.66665C13.1467 6.66665 13.3333 6.4801 13.3333 6.24998C13.3333 6.01986 13.1467 5.83331 12.9167 5.83331M12.9167 6.66665C12.6866 6.66665 12.5 6.4801 12.5 6.24998C12.5 6.01986 12.6866 5.83331 12.9167 5.83331M12.9167 6.66665V5.83331"
                stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
              <path
                d="M3.0818 16.456C2.0835 15.2871 2.0835 13.5247 2.0835 9.99998C2.0835 6.4752 2.0835 4.71281 3.0818 3.54395C3.22356 3.37796 3.37815 3.22338 3.54413 3.08162C4.713 2.08331 6.47539 2.08331 10.0002 2.08331C13.5249 2.08331 15.2873 2.08331 16.4562 3.08162C16.6222 3.22338 16.7767 3.37796 16.9185 3.54395C17.9168 4.71281 17.9168 6.4752 17.9168 9.99998C17.9168 13.5247 17.9168 15.2871 16.9185 16.456C16.7767 16.622 16.6222 16.7766 16.4562 16.9183C15.2873 17.9166 13.5249 17.9166 10.0002 17.9166C6.47539 17.9166 4.713 17.9166 3.54413 16.9183C3.37815 16.7766 3.22356 16.622 3.0818 16.456Z"
                stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            Flux Uno
          </a>
          <a href="gallery">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path
                d="M5 14.9788C5.10725 16.0691 5.34963 16.803 5.89742 17.3507C6.87997 18.3333 8.46133 18.3333 11.6241 18.3333C14.7868 18.3333 16.3682 18.3333 17.3507 17.3507C18.3333 16.3682 18.3333 14.7868 18.3333 11.6241C18.3333 8.46133 18.3333 6.87997 17.3507 5.89742C16.803 5.34963 16.0691 5.10725 14.9788 5"
                stroke="currentColor" stroke-width="1.5" />
              <path
                d="M1.6665 8.33335C1.6665 5.19065 1.6665 3.61931 2.64281 2.643C3.61913 1.66669 5.19047 1.66669 8.33317 1.66669C11.4758 1.66669 13.0473 1.66669 14.0235 2.643C14.9998 3.61931 14.9998 5.19065 14.9998 8.33335C14.9998 11.476 14.9998 13.0474 14.0235 14.0237C13.0473 15 11.4758 15 8.33317 15C5.19047 15 3.61913 15 2.64281 14.0237C1.6665 13.0474 1.6665 11.476 1.6665 8.33335Z"
                stroke="currentColor" stroke-width="1.5" />
              <path
                d="M1.6665 9.26541C2.18235 9.19982 2.70387 9.16749 3.22626 9.16857C5.43621 9.12774 7.59204 9.73024 9.30909 10.8687C10.9015 11.9245 12.0204 13.3775 12.4998 15"
                stroke="currentColor" stroke-width="1.5" stroke-linejoin="round" />
              <path d="M10.833 5.83331H10.8405" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            </svg>
            Galeri
          </a>
        </nav>
      </aside>

      <!-- Main -->
      <main class="main">
        <div class="grid">

          <!-- LEFT: Preview -->
          <section class="card preview">
            <div class="preview-viewport" id="viewport">
              <div class="ph">
                <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                  <path d="M19 3H5a2 2 0 0 0-2 2v14l4-4h12a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2Z" opacity=".25" />
                  <path d="m10 12 2.5 3 3.5-4 4 5H4l4-5 2 1z" />
                </svg>
                <div>Tidak ada gambar</div>
                <div class="muted">Hasil akan tampil di sini</div>
              </div>
              <img id="preview" alt="" style="max-width:100%; max-height:100%; display:none; object-fit:contain;" />
            </div>
            <div class="preview-footer">
              <button class="btn" id="btnDownload" title="Download" disabled>
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path
                    d="M14.5 9.50004C14.5 9.50004 11.1858 14 9.99994 14C8.81414 14 5.5 9.50004 5.5 9.50004M9.99994 13V1"
                    stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                  <path
                    d="M1 15.0001C1 15.9301 1 16.3951 1.10223 16.7766C1.37963 17.8118 2.18827 18.6205 3.22355 18.8979C3.60505 19.0001 4.07003 19.0001 5 19.0001H15C15.93 19.0001 16.395 19.0001 16.7765 18.8979C17.8117 18.6205 18.6204 17.8118 18.8978 16.7766C19 16.3951 19 15.9301 19 15.0001"
                    stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
              </button>
              <!-- Tombol Interrupt ditambahkan di sini -->
              <button class="btn danger" id="btnInterrupt" title="Interrupt" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                  <path d="M5 5h6v6H5V5z" />
                </svg>
                Interrupt
              </button>
              <button class="btn primary" id="btnGenerate">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M5 12h14M12 5l7 7-7 7" />
                </svg>
                Generate image
              </button>
            </div>
          </section>

          <!-- RIGHT: Controls -->
          <aside class="panel">
            <!-- Prompt -->
            <section class="group">
              <div class="hd">
                <h3>prompt</h3>
              </div>
              <div class="bd">
                <textarea id="prompt" placeholder="Masukan Text di sini..."></textarea>
                <label class="chip" for="fileInput">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M16.5 6.5a4.5 4.5 0 0 1 0 6.36l-6.36 6.36a4.5 4.5 0 1 1-6.36-6.36l3.18-3.18" fill="none"
                      stroke="currentColor" stroke-width="1.5" />
                    <path d="M8 16l8-8a2.5 2.5 0 1 1 3.54 3.54L11.5 19.58" />
                  </svg>
                  Tambahkan Foto &amp; File
                </label>
                <input id="fileInput" type="file" accept="image/*" hidden />
                <div id="referencePreviewContainer"
                  style="display:none; margin-top: 12px; position: relative; width: 100px; height: 100px;">
                  <img id="referencePreviewImage" src="#" alt="Reference"
                    style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px; border: 1px solid var(--line);" />
                  <button id="removeReferenceBtn" title="Remove image"
                    style="position: absolute; top: -5px; right: -5px; background: var(--panel); border: 1px solid var(--line); color: var(--text); border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; line-height: 1;">&times;</button>
                </div>
              </div>
            </section>

            <!-- Settings -->
            <section class="group">
              <div class="hd">
                <h3>Settings</h3>
                <button class="reset" id="btnReset">Reset</button>
              </div>
              <div class="bd">

                <div class="inline">
                  <div>
                    <label class="muted">Width</label>
                    <div class="row">
                      <input id="widthRange" type="range" min="256" max="1536" step="32" value="1024" class="range" />
                      <div></div>
                      <input id="widthNum" type="number" min="256" max="1536" step="32" value="1024" class="input" />
                    </div>
                  </div>
                  <div>
                    <label class="muted">Height</label>
                    <div class="row">
                      <input id="heightRange" type="range" min="256" max="1536" step="32" value="1024" class="range" />
                      <div></div>
                      <input id="heightNum" type="number" min="256" max="1536" step="32" value="1024" class="input" />
                    </div>
                  </div>
                </div>

                <div>
                  <label class="muted">Steps</label>
                  <div class="row">
                    <input id="stepsRange" type="range" min="1" max="60" step="1" value="4" class="range" />
                    <div></div>
                    <input id="stepsNum" type="number" min="1" max="60" step="1" value="4" class="input" />
                  </div>
                </div>

                <div>
                  <label class="muted">CFG</label>
                  <div class="row">
                    <input id="cfgRange" type="range" min="1" max="30" step="1" value="1" class="range" />
                    <div></div>
                    <input id="cfgNum" type="number" min="1" max="30" step="1" value="1" class="input" />
                  </div>
                </div>

                <div>
                  <label class="muted">Seed</label>
                  <div class="seed-row">
                    <input id="seedNum" type="number" class="input" value="1" />
                    <button class="icon-btn" id="btnRandSeed" title="Acak seed">
                      <svg width="24" height="25" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path
                          d="M19.5576 4.5L20.4551 5.47574C20.8561 5.91165 21.0566 6.12961 20.9861 6.31481C20.9155 6.5 20.632 6.5 20.0649 6.5C18.7956 6.5 17.2771 6.29493 16.1111 6.9733C15.3903 7.39272 14.8883 8.12517 14.0392 9.5M3 18.5H4.58082C6.50873 18.5 7.47269 18.5 8.2862 18.0267C9.00708 17.6073 9.50904 16.8748 10.3582 15.5"
                          stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                        <path
                          d="M19.5576 20.5L20.4551 19.5243C20.8561 19.0883 21.0566 18.8704 20.9861 18.6852C20.9155 18.5 20.632 18.5 20.0649 18.5C18.7956 18.5 17.2771 18.7051 16.1111 18.0267C15.2976 17.5534 14.7629 16.6815 13.6935 14.9376L10.7038 10.0624C9.63441 8.31853 9.0997 7.4466 8.2862 6.9733C7.47269 6.5 6.50873 6.5 4.58082 6.5H3"
                          stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                      </svg>
                    </button>
                  </div>
                </div>

                <div>
                  <label class="muted">Sampler</label>
                  <select id="sampler">
                    <option value="euler">euler</option>
                    <option value="euler_cfg_pp">euler_cfg_pp</option>
                    <option value="euler_ancestral">euler_ancestral</option>
                    <option value="euler_ancestral_cfg_pp">euler_ancestral_cfg_pp</option>
                    <option value="heun">heun</option>
                    <option value="heunpp2">heunpp2</option>
                    <option value="dpm_2">dpm_2</option>
                    <option value="dpm_2_ancestral">dpm_2_ancestral</option>
                    <option value="lms">lms</option>
                    <option value="dpm_fast">dpm_fast</option>
                    <option value="dpm_adaptive">dpm_adaptive</option>
                    <option value="dpmpp_2s_ancestral">dpmpp_2s_ancestral</option>
                    <option value="dpmpp_2s_ancestral_cfg_pp">dpmpp_2s_ancestral_cfg_pp</option>
                    <option value="dpmpp_sde" selected>dpmpp_sde</option>
                    <option value="dpmpp_sde_gpu">dpmpp_sde_gpu</option>
                    <option value="dpmpp_2m">dpmpp_2m</option>
                    <option value="dpmpp_2m_cfg_pp">dpmpp_2m_cfg_pp</option>
                    <option value="dpmpp_2m_sde">dpmpp_2m_sde</option>
                    <option value="dpmpp_2m_sde_gpu">dpmpp_2m_sde_gpu</option>
                    <option value="dpmpp_3m_sde">dpmpp_3m_sde</option>
                    <option value="dpmpp_3m_sde_gpu">dpmpp_3m_sde_gpu</option>
                    <option value="ddpm">ddpm</option>
                    <option value="lcm">lcm</option>
                    <option value="ipndm">ipndm</option>
                    <option value="ipndm_v">ipndm_v</option>
                    <option value="deis">deis</option>
                    <option value="res_multistep">res_multistep</option>
                    <option value="res_multistep_cfg_pp">res_multistep_cfg_pp</option>
                    <option value="res_multistep_ancestral">res_multistep_ancestral</option>
                    <option value="res_multistep_ancestral_cfg_pp">res_multistep_ancestral_cfg_pp</option>
                    <option value="gradient_estimation">gradient_estimation</option>
                    <option value="gradient_estimation_cfg_pp">gradient_estimation_cfg_pp</option>
                    <option value="er_sde">er_sde</option>
                    <option value="seeds_2">seeds_2</option>
                    <option value="seeds_3">seeds_3</option>
                    <option value="sa_solver">sa_solver</option>
                    <option value="sa_solver_pece">sa_solver_pece</option>
                    <option value="ddim">ddim</option>
                    <option value="uni_pc">uni_pc</option>
                    <option value="uni_pc_bh2">uni_pc_bh2</option>
                  </select>
                </div>

                <div>
                  <label class="muted">Scheduler</label>
                  <select id="scheduler">
                    <option value="simple">simple</option>
                    <option value="sgm_uniform">sgm_uniform</option>
                    <option value="karras" selected>karras</option>
                    <option value="exponential">exponential</option>
                    <option value="ddim_uniform">ddim_uniform</option>
                    <option value="beta">beta</option>
                    <option value="normal">normal</option>
                    <option value="linear_quadratic">linear_quadratic</option>
                    <option value="kl_optimal">kl_optimal</option>
                  </select>
                </div>

                <!-- ===== Upscaler (Diubah) ===== -->
                <details class="box" id="upscalerBox">
                  <summary>Upscaler</summary>
                  <div class="inner" style="gap:12px">
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <input type="checkbox" id="enableUpscaler" style="width: 16px; height: 16px; margin: 0;">
                      <label for="enableUpscaler" style="font-weight: 500; cursor: pointer;">Enable Upscaler</label>
                    </div>
                    <div id="scaleFactorControls" style="display: none;">
                      <label class="muted">Scale Factor</label>
                      <div class="row">
                        <input id="scaleFactorRange" type="range" min="1" max="4" step="0.1" value="2" class="range">
                        <div></div>
                        <input id="scaleFactorNum" type="number" min="1" max="4" step="0.1" value="2" class="input">
                      </div>
                    </div>
                  </div>
                </details>

                <!-- ===== LoRA Dinamis ===== -->
                <details class="box" id="loraBox">
                  <summary>LoRA</summary>
                  <div class="inner" style="gap:12px">
                    <div id="loraList" class="lora-list" style="display:flex; flex-direction:column; gap:10px"></div>

                    <!-- Template (disembunyikan, dipakai JS) -->
                    <template id="loraRowTpl">
                      <div class="lora-row"
                        style="display:grid; grid-template-columns:1fr 1fr 70px 40px; gap:10px; align-items:center">
                        <input class="input lora-name" placeholder="Nama LoRA (file/alias)" />
                        <input type="range" min="0" max="1" step="0.05" value="0.8" class="range lora-strength-range" />
                        <input type="number" min="0" max="1" step="0.05" value="0.8" class="input lora-strength-num" />
                        <button type="button" class="icon-btn lora-remove" title="Hapus LoRA"
                          style="border:1px solid var(--line)">
                          <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                            <path d="M7 7h10v12a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2V7Z" opacity=".2" />
                            <path d="M6 7h12M10 11v6m4-6v6M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2" stroke="currentColor"
                              stroke-width="1.4" fill="none" />
                          </svg>
                        </button>
                      </div>
                    </template>

                    <div style="display:flex; gap:8px">
                      <select id="loraNameInput" class="input" style="flex:1">
                        <option value="" disabled selected>Pilih LoRA...</option>
                        <!-- Opsi LoRA akan dimuat oleh JavaScript -->
                      </select>
                      <input id="loraStrengthInput" type="number" min="0" max="1" step="0.05" value="0.8" class="input"
                        style="width:120px" />
                      <button type="button" class="btn" id="btnAddLora">Tambah LoRA</button>
                    </div>

                    <div class="muted">Tips: pilih nama → klik “Tambah LoRA”. Kamu bisa menambah beberapa item, atur
                      strength, atau hapus baris.</div>
                  </div>
                </details>

                <!-- ===== ControlNet Dinamis ===== -->
                <details class="box" id="cnBox">
                  <summary>ControlNet</summary>
                  <div class="inner" style="gap:12px">
                    <div id="cnList" style="display:flex; flex-direction:column; gap:10px"></div>

                    <!-- Template baris ControlNet -->
                    <template id="cnRowTpl">
                      <div class="cn-row"
                        style="display:grid; grid-template-columns:1fr 120px 120px 40px; gap:8px; align-items:center">
                        <select class="input cn-preproc">
                          <option value="none">none</option>
                          <option value="CannyEdgePreprocessor">CannyEdgePreprocessor</option>
                          <option value="DepthAnythingPreprocessor">DepthAnythingPreprocessor</option>
                          <option value="OpenposePreprocessor">OpenposePreprocessor</option>
                          <option value="LineartStandardPreprocessor">LineartStandardPreprocessor</option>
                        </select>
                        <input type="number" class="input cn-res" min="256" step="32" value="512"
                          placeholder="Resolution" />
                        <input type="file" class="input cn-image" accept="image/*" />
                        <button type="button" class="icon-btn cn-remove" title="Hapus ControlNet"
                          style="border:1px solid var(--line)">
                          <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                            <path d="M7 7h10v12a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2V7Z" opacity=".2" />
                            <path d="M6 7h12M10 11v6m4-6v6M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2" stroke="currentColor"
                              stroke-width="1.4" fill="none" />
                          </svg>
                        </button>
                      </div>
                    </template>

                    <div style="display:flex; gap:8px">
                      <select id="cnPreprocInput" class="input" style="flex:1">
                        <option value="none">none</option>
                        <option value="CannyEdgePreprocessor">CannyEdgePreprocessor</option>
                        <option value="DepthAnythingPreprocessor">DepthAnythingPreprocessor</option>
                        <option value="OpenposePreprocessor">OpenposePreprocessor</option>
                        <option value="LineartStandardPreprocessor">LineartStandardPreprocessor</option>
                      </select>
                      <input id="cnResInput" type="number" min="256" step="32" value="512" class="input"
                        style="width:100px" />
                      <button type="button" class="btn" id="btnAddCn">Tambah CN</button>
                    </div>

                    <div class="muted">Tips: pilih preprocessor & resolusi, lalu “Tambah CN”. Bisa tambah beberapa baris
                      ControlNet.</div>
                  </div>
                </details>
              </div>
            </section>
          </aside>
        </div>
      </main>
    </div>
  </div>
  <script>
    let uploadedImageB64 = null; // Variabel untuk menyimpan gambar Base64
    let activePollingInterval = null; // Variabel global untuk interval polling

    // ===== Helper: bind range <-> number =====
    function bindRangeNumber(range, number) {
      if (!range || !number) return;
      const sync = (src, dst) => () => { dst.value = src.value; };
      range.addEventListener('input', sync(range, number));
      number.addEventListener('input', sync(number, range));
    }
    bindRangeNumber(document.getElementById('widthRange'), document.getElementById('widthNum'));
    bindRangeNumber(document.getElementById('heightRange'), document.getElementById('heightNum'));
    bindRangeNumber(document.getElementById('stepsRange'), document.getElementById('stepsNum'));
    bindRangeNumber(document.getElementById('cfgRange'), document.getElementById('cfgNum'));
    bindRangeNumber(document.getElementById('scaleFactorRange'), document.getElementById('scaleFactorNum'));

    // ===== Upscaler UI Logic =====
    const enableUpscaler = document.getElementById('enableUpscaler');
    const scaleFactorControls = document.getElementById('scaleFactorControls');
    enableUpscaler.addEventListener('change', () => {
      scaleFactorControls.style.display = enableUpscaler.checked ? 'block' : 'none';
    });

    // Seed random
    const seedNum = document.getElementById('seedNum');
    document.getElementById('btnRandSeed').addEventListener('click', () => {
      seedNum.value = Math.floor(Math.random() * 2147483647);
    });

    // Fungsi untuk membersihkan gambar referensi
    function clearReferenceImage() {
      uploadedImageB64 = null;
      document.getElementById('fileInput').value = '';
      document.getElementById('referencePreviewContainer').style.display = 'none';
      document.getElementById('referencePreviewImage').src = '#';
    }

    // Reset default
    document.getElementById('btnReset').addEventListener('click', () => {
      document.getElementById('widthRange').value = document.getElementById('widthNum').value = 1024;
      document.getElementById('heightRange').value = document.getElementById('heightNum').value = 1024;
      document.getElementById('stepsRange').value = document.getElementById('stepsNum').value = 22;
      document.getElementById('cfgRange').value = document.getElementById('cfgNum').value = 22;
      seedNum.value = 1;
      document.getElementById('sampler').value = 'uni_pc';
      document.getElementById('scheduler').value = 'simple';
      document.getElementById('prompt').value = '';

      // Reset LoRA & ControlNet & Upscaler
      loraList.innerHTML = '';
      loraNameInput.value = '';
      loraStrengthInput.value = '0.8';
      cnList.innerHTML = '';
      cnPreprocInput.value = 'none';
      cnResInput.value = '512';
      enableUpscaler.checked = false;
      scaleFactorControls.style.display = 'none';
      document.getElementById('scaleFactorRange').value = document.getElementById('scaleFactorNum').value = 2;

      // Reset Reference/Faceswap image
      clearReferenceImage();
      document.getElementById('preview').style.display = 'none';
      document.querySelector('.preview-viewport .ph').style.display = 'block';
      document.getElementById('btnDownload').disabled = true;
    });

    // Listener untuk tombol hapus gambar referensi
    document.getElementById('removeReferenceBtn').addEventListener('click', clearReferenceImage);

    // Preview ketika upload & Konversi ke Base64
    const fileInput = document.getElementById('fileInput');
    fileInput.addEventListener('change', (e) => {
      const f = e.target.files?.[0];
      if (!f) {
        clearReferenceImage();
        return;
      }
      // Tampilkan preview referensi
      const url = URL.createObjectURL(f);
      const refContainer = document.getElementById('referencePreviewContainer');
      const refImg = document.getElementById('referencePreviewImage');

      refImg.src = url;
      refContainer.style.display = 'block';

      // Konversi ke Base64 untuk API
      fileToBase64(f)
        .then(b64 => {
          uploadedImageB64 = b64;
          console.log("Gambar referensi berhasil dikonversi ke Base64.");
        })
        .catch(err => {
          console.error("Gagal mengonversi gambar ke Base64:", err);
          clearReferenceImage();
        });
    });

    // ===== LoRA Dynamic =====
    const loraList = document.getElementById('loraList');
    const loraRowTpl = document.getElementById('loraRowTpl');
    const btnAddLora = document.getElementById('btnAddLora');
    const loraNameInput = document.getElementById('loraNameInput');
    const loraStrengthInput = document.getElementById('loraStrengthInput');

    // Fungsi untuk memuat daftar LoRA dari server
    async function loadLoras() {
      try {
        const response = await fetch('http://localhost:8000/models/loras');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const loraNames = await response.json();

        // Kosongkan opsi yang ada, sisakan placeholder
        loraNameInput.innerHTML = '<option value="" disabled selected>Pilih LoRA...</option>';

        // Isi dengan opsi baru dari API
        loraNames.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          loraNameInput.appendChild(option);
        });
        console.log("Daftar LoRA berhasil dimuat.");
      } catch (error) {
        console.error("Gagal memuat daftar LoRA:", error);
        // Beri tahu pengguna di UI jika gagal
        loraNameInput.innerHTML = '<option value="" disabled selected>Gagal memuat LoRA</option>';
      }
    }

    // Panggil fungsi untuk memuat LoRA saat halaman dimuat
    loadLoras();

    function bindLoraRangeNum(rangeEl, numEl) {
      rangeEl.addEventListener('input', () => { numEl.value = rangeEl.value; });
      numEl.addEventListener('input', () => {
        const v = Math.min(1, Math.max(0, parseFloat(numEl.value || 0)));
        numEl.value = isNaN(v) ? '0.80' : v.toFixed(2);
        rangeEl.value = isNaN(v) ? 0.8 : v;
      });
    }

    function addLoraRow(name = '', strength = 0.8) {
      const node = loraRowTpl.content.firstElementChild.cloneNode(true);
      const nameEl = node.querySelector('.lora-name');
      const rEl = node.querySelector('.lora-strength-range');
      const nEl = node.querySelector('.lora-strength-num');
      const rm = node.querySelector('.lora-remove');

      const lastDotIndex = name.lastIndexOf('.');
      const shortName = lastDotIndex !== -1 ? name.substring(0, lastDotIndex) : name;

      nameEl.value = shortName; // Display shortened name
      nameEl.dataset.fullName = name; // Store full name in data attribute
      nameEl.readOnly = true; // Make it non-editable by user

      rEl.value = strength;
      nEl.value = strength;

      bindLoraRangeNum(rEl, nEl);
      rm.addEventListener('click', () => node.remove());

      loraList.appendChild(node);
    }

    btnAddLora.addEventListener('click', () => {
      const name = (loraNameInput.value || '').trim();
      const strength = Math.min(1, Math.max(0, parseFloat(loraStrengthInput.value || '0.8')));
      if (!name) { alert('Pilih nama LoRA dulu.'); return; }
      addLoraRow(name, isNaN(strength) ? 0.8 : strength);
      loraNameInput.value = '';
      loraStrengthInput.value = '0.8';
    });

    // ===== ControlNet Dynamic =====
    const cnList = document.getElementById('cnList');
    const cnRowTpl = document.getElementById('cnRowTpl');
    const btnAddCn = document.getElementById('btnAddCn');
    const cnPreprocInput = document.getElementById('cnPreprocInput');
    const cnResInput = document.getElementById('cnResInput');

    function addCnRow(preproc = 'none', res = 512, file = null) {
      const node = cnRowTpl.content.firstElementChild.cloneNode(true);
      const preprocEl = node.querySelector('.cn-preproc');
      const resEl = node.querySelector('.cn-res');
      const fileEl = node.querySelector('.cn-image');
      const rm = node.querySelector('.cn-remove');

      preprocEl.value = preproc;
      resEl.value = res;

      rm.addEventListener('click', () => node.remove());

      cnList.appendChild(node);
    }

    btnAddCn.addEventListener('click', () => {
      const preproc = cnPreprocInput.value;
      const res = parseInt(cnResInput.value || '512', 10);
      addCnRow(preproc, isNaN(res) ? 512 : res);
      cnResInput.value = 512;
      cnPreprocInput.value = 'none';
    });

    // ===== Helper: File to Base64 =====
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => {
          // Hapus prefix "data:*/*;base64,"
          resolve(reader.result.split(',')[1]);
        };
        reader.onerror = error => reject(error);
      });
    }

    // ===== Data Collection Functions (Updated for API) =====
    function collectLoras() {
      const items = [];
      loraList.querySelectorAll('.lora-row').forEach(row => {
        const nameInput = row.querySelector('.lora-name');
        const name = nameInput.dataset.fullName ? nameInput.dataset.fullName.trim() : nameInput.value.trim(); // Read from data-attribute
        const strength = parseFloat(row.querySelector('.lora-strength-num').value || '0.8');
        if (name) {
          items.push({
            lora_name: name,
            strength_model: strength,
            strength_clip: strength // Map strength to both model and clip
          });
        }
      });
      return items;
    }

    async function collectControls() {
      const items = [];
      const rows = cnList.querySelectorAll('.cn-row');
      for (const row of rows) {
        const preproc = row.querySelector('.cn-preproc').value;
        const res = parseInt(row.querySelector('.cn-res').value || '512', 10);
        const fileInput = row.querySelector('.cn-image');
        let imageB64 = "";

        if (fileInput.files && fileInput.files[0]) {
          try {
            imageB64 = await fileToBase64(fileInput.files[0]);
          } catch (error) {
            console.error("Error converting ControlNet image to Base64:", error);
            continue; // Lewati item ini jika konversi gambar gagal
          }
        }

        items.push({
          image: imageB64,
          preprocessor: preproc,
          resolution: res,
          strength: 0.8 // Default strength karena tidak ada di UI
        });
      }
      return items;
    }

    function collectUpscale() {
      const isEnabled = document.getElementById('enableUpscaler').checked;
      if (!isEnabled) {
        return { enabled: false };
      }
      const scale = parseFloat(document.getElementById('scaleFactorNum').value || '2');
      return { enabled: true, scale: scale };
    }

    function collectFaceswap() {
      if (uploadedImageB64) {
        return {
          enabled: true,
          source_image_b64: uploadedImageB64,
          face_boost: {
            enabled: true, // Default value, karena tidak ada di UI
            visibility: 1.0, // Default value
            codeformer_weight: 0.5 // Default value
          }
        };
      }
      return { enabled: false };
    }

    // ===== Interrupt Logic =====
    const btnInterrupt = document.getElementById('btnInterrupt');
    btnInterrupt.addEventListener('click', async () => {
      try {
        const response = await fetch('http://localhost:8000/interrupt', { method: 'POST' });
        if (response.ok) {
          console.log('Interrupt request sent.');
          alert('Proses generasi dihentikan.');
          resetGenerateButton(); // This will clear the interval and reset the UI
          // Reset the preview placeholder
          const previewPlaceholder = document.querySelector('.preview-viewport .ph');
          previewPlaceholder.innerHTML = `
              <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <path d="M19 3H5a2 2 0 0 0-2 2v14l4-4h12a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2Z" opacity=".25"/>
                <path d="m10 12 2.5 3 3.5-4 4 5H4l4-5 2 1z"/>
              </svg>
              <div>Proses Dibatalkan</div>`;
          previewPlaceholder.style.display = 'block';
          document.getElementById('preview').style.display = 'none';
        } else {
          alert('Gagal mengirim perintah interupsi.');
        }
      } catch (error) {
        console.error('Interrupt request failed:', error);
        alert('Gagal menghubungi server untuk interupsi.');
      }
    });


    // ===== Polling and Result Handling =====
    function resetGenerateButton() {
      if (activePollingInterval) {
        clearInterval(activePollingInterval);
        activePollingInterval = null;
      }
      const btn = document.getElementById('btnGenerate');
      const btnInterrupt = document.getElementById('btnInterrupt');
      btn.disabled = false;
      btn.innerHTML = `
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M5 12h14M12 5l7 7-7 7" /></svg>
      Generate image
    `;
      btnInterrupt.style.display = 'none';
    }

    function pollForResult(promptId) {
      const btn = document.getElementById('btnGenerate');
      const btnInterrupt = document.getElementById('btnInterrupt');
      const previewPlaceholder = document.querySelector('.preview-viewport .ph');
      const previewImg = document.getElementById('preview');

      btn.innerHTML = 'Generating...';
      btnInterrupt.style.display = 'inline-flex';
      previewPlaceholder.innerHTML = `<div style="word-break: break-all;">Processing prompt ID: ${promptId}</div><div class="muted">Waiting for result...</div>`;
      previewPlaceholder.style.display = 'block';
      previewImg.style.display = 'none';

      const maxAttempts = 120;
      let attempt = 0;

      if (activePollingInterval) {
        clearInterval(activePollingInterval);
      }

      activePollingInterval = setInterval(async () => {
        if (attempt++ >= maxAttempts) {
          clearInterval(activePollingInterval);
          activePollingInterval = null;
          alert('Generation timed out.');
          resetGenerateButton();
          previewPlaceholder.innerHTML = `<div>Timeout</div>`;
          return;
        }

        try {
          const response = await fetch(`http://localhost:8000/history/${promptId}`);
          if (!response.ok) throw new Error('Network response was not ok');
          const history = await response.json();

          if (Object.keys(history).length > 0) {
            clearInterval(activePollingInterval);
            activePollingInterval = null;
            console.log("Generation complete:", history);

            const promptData = history[promptId];
            let outputImage = null;
            if (promptData && promptData.outputs) {
              for (const nodeId in promptData.outputs) {
                const nodeOutput = promptData.outputs[nodeId];
                if (nodeOutput.images && nodeOutput.images.length > 0) {
                  outputImage = nodeOutput.images[0];
                  break;
                }
              }
            }

            if (outputImage && outputImage.filename) {
              const { filename, subfolder } = outputImage;
              const imageUrl = `http://localhost:8000/image?filename=${encodeURIComponent(filename)}&subfolder=${encodeURIComponent(subfolder || '')}`;

              previewImg.onload = () => {
                previewPlaceholder.style.display = 'none';
                previewImg.style.display = 'block';
              };
              previewImg.onerror = () => {
                alert(`Failed to load image from ${imageUrl}.`);
              };
              previewImg.src = imageUrl;

              const btnDownload = document.getElementById('btnDownload');
              btnDownload.disabled = false;
              btnDownload.onclick = () => {
                const a = document.createElement('a');
                a.href = imageUrl;
                a.download = filename;
                a.click();
              };
            } else {
              alert('Generation finished, but no image output was found.');
            }
            resetGenerateButton();
          }
        } catch (error) {
          console.error('Polling error:', error);
        }
      }, 1500); // Check every 1.5 seconds
    }


    // ===== Tombol Generate (Tunggal & Terpusat) =====
    document.getElementById('btnGenerate').addEventListener('click', async () => {
      const btn = document.getElementById('btnGenerate');
      btn.disabled = true;
      btn.innerHTML = 'Sending request...';

      try {
        const loraItems = collectLoras();
        const controlItems = await collectControls();
        const upscaleData = collectUpscale();
        const faceswapData = collectFaceswap();

        const body = {
          preset: "t2i",
          params: {
            prompt: document.getElementById('prompt').value,
            seed: +document.getElementById('seedNum').value,
            steps: +document.getElementById('stepsNum').value,
            cfg: +document.getElementById('cfgNum').value,
            sampler: document.getElementById('sampler').value,
            scheduler: document.getElementById('scheduler').value,
            denoise: 1.0, // Default value from example
            width: +document.getElementById('widthNum').value,
            height: +document.getElementById('heightNum').value,
            loras: loraItems,
            controls: controlItems,
            upscale: upscaleData,
            faceswap: faceswapData
          }
        };

        if (body.params.loras.length === 0) delete body.params.loras;
        if (body.params.controls.length === 0) delete body.params.controls;

        console.log("Mengirim payload ke /generate:", JSON.stringify(body, null, 2));

        const response = await fetch('http://localhost:8000/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const result = await response.json();

        if (response.ok && result.prompt_id) {
          console.log('Request sukses, prompt ID diterima:', result.prompt_id);
          pollForResult(result.prompt_id); // Start polling for the result
        } else {
          console.error('Error:', result);
          const errorMsg = result.detail ? JSON.stringify(result.detail, null, 2) : 'Terjadi kesalahan pada server.';
          alert(`Error: ${errorMsg}`);
          resetGenerateButton();
        }

      } catch (error) {
        console.error('Request gagal:', error);
        alert('Gagal menghubungi server. Pastikan server berjalan di localhost:8000.');
        resetGenerateButton();
      }
    });



    // ===== Dark Mode Toggle =====
    const themeToggleBtn = document.getElementById('themeToggleBtn');
    const themeIcon = document.getElementById('themeIcon');
    const sunIcon = `<g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41m11.32 11.32l1.41 1.41M2 12h2m16 0h2M4.93 19.07l1.41-1.41m11.32-11.32l1.41-1.41"/></g>`;
    const moonIcon = `<path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>`;

    function setTheme(theme) {
      document.body.dataset.theme = theme;
      localStorage.setItem('theme', theme);
      if (theme === 'dark') {
        themeIcon.innerHTML = sunIcon;
      } else {
        themeIcon.innerHTML = moonIcon;
      }
    }

    themeToggleBtn.addEventListener('click', () => {
      const currentTheme = document.body.dataset.theme || 'light';
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      setTheme(newTheme);
    });

    // Load saved theme from localStorage or system preference
    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (savedTheme) {
      setTheme(savedTheme);
    } else if (prefersDark) {
      setTheme('dark');
    } else {
      setTheme('light');
    }
  </script>
</body>

</html>